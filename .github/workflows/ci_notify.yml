name: CI Notify

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  notify-on-failure:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest

    steps:
- name: Notify Slack on CI failure
  if: failure()
  shell: bash
  env:
    SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
    REPO: ${{ github.repository }}
    WORKFLOW: ${{ github.workflow }}
    RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    COMMIT: ${{ github.sha }}
    BRANCH: ${{ github.ref_name }}
  run: |
    if [ -z "$SLACK_WEBHOOK" ]; then
      echo "No SLACK_WEBHOOK set; skipping Slack notification"
      exit 0
    fi

    payload=$(jq -n \
      --arg repo "$REPO" \
      --arg wf "$WORKFLOW" \
      --arg url "$RUN_URL" \
      --arg commit "$COMMIT" \
      --arg branch "$BRANCH" \
      '{text: "‚ùå CI FAILED\nRepo: \($repo)\nWorkflow: \($wf)\nBranch: \($branch)\nCommit: \($commit)\n\($url)"}')

    curl -s -X POST \
      -H "Content-type: application/json" \
      --data "$payload" \
      "$SLACK_WEBHOOK"
