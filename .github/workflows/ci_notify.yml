name: CI Notify

on:
  workflow_run:
    workflows: [CI]
    types:
      - completed

jobs:
  notify-on-failure:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Notify Slack on CI failure
        continue-on-error: true
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          REPO: ${{ github.repository }}
          WORKFLOW: ${{ github.event.workflow_run.name }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          COMMIT: ${{ github.event.workflow_run.head_commit.id }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          # Trim whitespace and CR/LF from the secret
          SLACK_WEBHOOK="$(printf '%s' "$SLACK_WEBHOOK" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"

          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "No SLACK_WEBHOOK set; skipping notification"
            exit 0
          fi

          # Basic validation: must start with https://
          if ! printf '%s' "$SLACK_WEBHOOK" | grep -qE '^https://'; then
            echo "SLACK_WEBHOOK does not appear to be a valid HTTPS URL; skipping notification"
            exit 0
          fi

          # Build payload safely and send via stdin to avoid shell-quoting issues
          PAYLOAD=$(printf '{"text":"‚ùå CI FAILED\nRepo: %s\nWorkflow: %s\nBranch: %s\nCommit: %s\n<%s|View run>"}' "$REPO" "$WORKFLOW" "$BRANCH" "$COMMIT" "$RUN_URL")

          printf '%s' "$PAYLOAD" | curl -s -S -X POST \
            -H "Content-Type: application/json" \
            --data-binary @- \
            "$SLACK_WEBHOOK" || echo "Slack notify failed or returned non-2xx; continuing"
