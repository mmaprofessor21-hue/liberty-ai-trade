name: CI Notify

on:
  workflow_run:
    workflows: [CI]
    types:
      - completed

jobs:
  notify-on-failure:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Notify Slack on CI failure
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          REPO: ${{ github.repository }}
          WORKFLOW: ${{ github.event.workflow_run.name }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          COMMIT: ${{ github.event.workflow_run.head_commit.id }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          # Skip gracefully when webhook not configured
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "No SLACK_WEBHOOK set; skipping notification"
            exit 0
          fi

          # Build payload without jq to avoid requiring extra packages in runner
          PAYLOAD=$(printf '{"text":"CI Failure\nRepo: %s\nWorkflow: %s\nBranch: %s\nCommit: %s\n<%s|View run>"}' "$REPO" "$WORKFLOW" "$BRANCH" "$COMMIT" "$RUN_URL")

          # Send notification but do not fail the job if Slack returns non-2xx
          curl -s -S -X POST \
            -H "Content-type: application/json" \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK" || echo "Slack notify failed or returned non-2xx; continuing"
