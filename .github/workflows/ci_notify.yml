name: CI Notify

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  notify-on-failure:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Notify Slack on CI failure (safe, non-blocking)
        shell: bash
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          REPO: ${{ github.repository }}
          WORKFLOW: ${{ github.event.workflow_run.name }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          COMMIT: ${{ github.event.workflow_run.head_sha }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          set +e  # üî¥ never fail this job

          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "‚ÑπÔ∏è SLACK_WEBHOOK not set ‚Äî skipping Slack notification"
            exit 0
          fi

          # Validate webhook format without leaking it
          if ! printf '%s' "$SLACK_WEBHOOK" | grep -qE '^https://hooks\.slack\.com/'; then
            echo "‚ö†Ô∏è SLACK_WEBHOOK is present but malformed ‚Äî skipping notification"
            exit 0
          fi

          payload=$(jq -n \
            --arg repo "$REPO" \
            --arg wf "$WORKFLOW" \
            --arg url "$RUN_URL" \
            --arg commit "$COMMIT" \
            --arg branch "$BRANCH" \
            '{text: ("‚ùå CI FAILED\n" +
                     "Repo: " + $repo + "\n" +
                     "Workflow: " + $wf + "\n" +
                     "Branch: " + $branch + "\n" +
                     "Commit: " + $commit + "\n" +
                     "<" + $url + "|View run>") }')

          printf '%s' "$payload" | \
            curl -sS -X POST \
              -H "Content-Type: application/json" \
              --data-binary @- \
              "$SLACK_WEBHOOK" || \
            echo "‚ö†Ô∏è Slack notification failed but CI continues"
